<h2 id="welcome">Manager Dashboard</h2>
<button onclick="logout()">Logout</button>
<section>
  <button onclick="viewUsers()">View Employees</button>
</section>

<section>
  <h3>Create Post</h3>
  <form id="postForm">
    <textarea name="content" required></textarea>
    <button type="submit">Post</button>
  </form>
</section>

<section>
  <h3>Posts</h3>
  <ul id="postList"></ul>
</section>

<section>
  <h3>Change Password</h3>
  <form id="passwordForm">
    <input name="oldPassword" type="password" placeholder="Old Password" required />
    <input name="newPassword" type="password" placeholder="New Password" required />
    <button type="submit">Change</button>
  </form>
</section>

<script>
  const token = localStorage.getItem('token');

  fetch('/api/auth/session').then(res => res.json()).then(u => {
    document.getElementById('welcome').textContent = `Welcome, ${u.username}`;
  }).catch(() => {});

  async function viewUsers() {
    const res = await fetch('/api/users', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await res.json();
    alert(JSON.stringify(data));
  }

  document.getElementById('postForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const content = e.target.content.value.trim();
    if (!content) return;
    await fetch('/api/posts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({ content })
    });
    e.target.reset();
    loadPosts();
  });

  async function loadPosts() {
    const res = await fetch('/api/posts', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const posts = await res.json();
    const list = document.getElementById('postList');
    list.innerHTML = '';
    posts.forEach(p => {
      const li = document.createElement('li');
      li.textContent = `[${new Date(p.createdAt).toLocaleString()}] ${p.author}: ${p.content}`;
      const editBtn = document.createElement('button');
      editBtn.textContent = 'Edit';
      editBtn.onclick = async () => {
        const newContent = prompt('Edit post', p.content);
        if (!newContent) return;
        await fetch(`/api/posts/${p.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ content: newContent })
        });
        loadPosts();
      };
      const delBtn = document.createElement('button');
      delBtn.textContent = 'Delete';
      delBtn.onclick = async () => {
        await fetch(`/api/posts/${p.id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        loadPosts();
      };
      li.append(editBtn, delBtn);
      list.appendChild(li);
    });
  }

  document.getElementById('passwordForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const oldPassword = form.oldPassword.value;
    const newPassword = form.newPassword.value;

    const minLength = 8;
    const hasUppercase = /[A-Z]/.test(newPassword);
    const hasLowercase = /[a-z]/.test(newPassword);
    const hasNumber    = /[0-9]/.test(newPassword);
    const hasSpecial   = /[\W_]/.test(newPassword);

    const missing = [];

    if (newPassword.length < minLength) missing.push(`at least ${minLength} characters`);
    if (!hasUppercase) missing.push('an uppercase letter');
    if (!hasLowercase) missing.push('a lowercase letter');
    if (!hasNumber)    missing.push('a number');
    if (!hasSpecial)   missing.push('a special character');

    if (missing.length > 0) {
      alert(`New password must include ${missing.join(', ')}.`);
      return;
    }

    const res = await fetch('/api/users/me/password', {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ oldPassword, newPassword })
    });

    const data = await res.json();
    alert(data.message);
    form.reset();
  });

  loadPosts();
  async function logout() {
    await fetch('/api/auth/logout', { method: 'POST' });
    localStorage.removeItem('token');
    window.location.href = '/';
  }
  </script>

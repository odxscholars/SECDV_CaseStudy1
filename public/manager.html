<h2 id="welcome">Manager Dashboard</h2>
<ul id="loginLog">
    <li id="lastSuccessfulLogin"></li>
    <li id="lastFailedLogin"></li>
</ul>
<button onclick="logout()">Logout</button>
<section>
  <button onclick="viewUsers()">View Employees</button>
</section>

<section>
  <h3>Create Post</h3>
  <form id="postForm">
    <textarea name="content" required></textarea>
    <button type="submit">Post</button>
  </form>
</section>

<section>
  <h3>Posts</h3>
  <ul id="postList"></ul>
</section>

<section>
    <h3>Change Password</h3>
    <form id="passwordForm">
        <input name="oldPassword" type="password" placeholder="Old Password" required />
        <input name="newPassword" type="password" placeholder="New Password" required id="passwordInput"/>
        <button type="submit">Change</button>
    </form>

   <p> Your new password must contain: </p>
    <ul id="passwordChecklist">
        <li id="check-length">❌ At least 8 characters</li>
        <li id="check-uppercase">❌ One uppercase letter</li>
        <li id="check-lowercase">❌ One lowercase letter</li>
        <li id="check-number">❌ One number</li>
        <li id="check-special">❌ One special character</li>
    </ul>
</section>

<script>
  const token = localStorage.getItem('token');

  fetch('/api/auth/session').then(res => res.json()).then(u => {
    document.getElementById('welcome').textContent = `Welcome, ${u.user.username}`;
    document.getElementById('lastSuccessfulLogin').textContent = u.user.lastLogin 
      ? `Last successful login: ${new Date(u.user.lastLogin).toLocaleString()}`
      : 'Last successful login: Never';
    document.getElementById('lastFailedLogin').textContent = u.user.lastFailedLogin 
      ? `Last failed login: ${new Date(u.user.lastFailedLogin).toLocaleString()}`
      : 'Last failed login: Never';
  }).catch(() => {});

  async function viewUsers() {
    const res = await fetch('/api/users', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await res.json();
    alert(JSON.stringify(data));
  }

  document.getElementById('postForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const content = e.target.content.value.trim();
    if (!content) return;
    await fetch('/api/posts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({ content })
    });
    e.target.reset();
    loadPosts();
  });

  async function loadPosts() {
    const res = await fetch('/api/posts', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const posts = await res.json();
    const list = document.getElementById('postList');
    list.innerHTML = '';
    posts.forEach(p => {
      const li = document.createElement('li');
      li.textContent = `[${new Date(p.createdAt).toLocaleString()}] ${p.author}: ${p.content}`;
      const editBtn = document.createElement('button');
      editBtn.textContent = 'Edit';
      editBtn.onclick = async () => {
        const newContent = prompt('Edit post', p.content);
        if (!newContent) return;
        await fetch(`/api/posts/${p.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ content: newContent })
        });
        loadPosts();
      };
      const delBtn = document.createElement('button');
      delBtn.textContent = 'Delete';
      delBtn.onclick = async () => {
        await fetch(`/api/posts/${p.id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        loadPosts();
      };
      li.append(editBtn, delBtn);
      list.appendChild(li);
    });
  }

  const passwordInput = document.getElementById('passwordInput');
  const checkLength = document.getElementById('check-length');
  const checkUppercase = document.getElementById('check-uppercase');
  const checkLowercase = document.getElementById('check-lowercase');
  const checkNumber = document.getElementById('check-number');
  const checkSpecial = document.getElementById('check-special');

  passwordInput.addEventListener('input', () => {
    const password = passwordInput.value;

    updateChecklist(checkLength, password.length >= 8);
    updateChecklist(checkUppercase, /[A-Z]/.test(password));
    updateChecklist(checkLowercase, /[a-z]/.test(password));
    updateChecklist(checkNumber, /[0-9]/.test(password));
    updateChecklist(checkSpecial, /[\W_]/.test(password));
  });

  function updateChecklist(element, valid) {
    if (valid) {
        element.textContent = '✅ ' + element.textContent.slice(2);
        element.classList.add('valid');
        element.classList.remove('invalid');
    } else {
        element.textContent = '❌ ' + element.textContent.slice(2);
        element.classList.add('invalid');
        element.classList.remove('valid');
    }
  }

  function resetChecklist() {
    updateChecklist(checkLength, false);
    updateChecklist(checkUppercase, false);
    updateChecklist(checkLowercase, false);
    updateChecklist(checkNumber, false);
    updateChecklist(checkSpecial, false);
  }

  document.getElementById('passwordForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const oldPassword = form.oldPassword.value;
    const newPassword = form.newPassword.value;

    const minLength = 8;
    const hasUppercase = /[A-Z]/.test(newPassword);
    const hasLowercase = /[a-z]/.test(newPassword);
    const hasNumber    = /[0-9]/.test(newPassword);
    const hasSpecial   = /[\W_]/.test(newPassword);

    const missing = [];

    if (newPassword.length < minLength) missing.push(`at least ${minLength} characters`);
    if (!hasUppercase) missing.push('an uppercase letter');
    if (!hasLowercase) missing.push('a lowercase letter');
    if (!hasNumber)    missing.push('a number');
    if (!hasSpecial)   missing.push('a special character');

    if (missing.length > 0) {
      alert(`New password must include ${missing.join(', ')}.`);
      return;
    }

    const res = await fetch('/api/users/me/password', {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ oldPassword, newPassword })
    });

    const data = await res.json();
    alert(data.message);
    form.reset();
    resetChecklist();
  });

  loadPosts();
  async function logout() {
    await fetch('/api/auth/logout', { method: 'POST' });
    localStorage.removeItem('token');
    window.location.href = '/';
  }
  </script>

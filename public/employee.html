<h2 id="welcome">Employee Dashboard</h2>
<button onclick="logout()">Logout</button>
<section>
  <button onclick="viewProfile()">View My Profile</button>
</section>

<section>
  <h3>Create Post</h3>
  <form id="postForm">
    <textarea name="content" required></textarea>
    <button type="submit">Post</button>
  </form>
</section>

<section>
  <h3>Posts</h3>
  <ul id="postList"></ul>
</section>

<script>
  const token = localStorage.getItem('token');
  let currentUser = null;

  fetch('/api/auth/session').then(res => res.json()).then(u => {
    currentUser = u;
    document.getElementById('welcome').textContent = `Welcome, ${u.username}`;
    loadPosts();
  }).catch(() => {
    loadPosts();
  });

  async function viewProfile() {
    const res = await fetch('/api/users/me', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await res.json();
    alert(JSON.stringify(data));
  }

  document.getElementById('postForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const content = e.target.content.value.trim();
    if (!content) return;
    await fetch('/api/posts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({ content })
    });
    e.target.reset();
    loadPosts();
  });

  async function loadPosts() {
    const res = await fetch('/api/posts', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const posts = await res.json();
    const list = document.getElementById('postList');
    list.innerHTML = '';
    posts.forEach(p => {
      const li = document.createElement('li');
      li.textContent = `[${new Date(p.createdAt).toLocaleString()}] ${p.author}: ${p.content}`;
      if (currentUser && p.author === currentUser.username) {
        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.onclick = async () => {
          const newContent = prompt('Edit post', p.content);
          if (!newContent) return;
          await fetch(`/api/posts/${p.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ content: newContent })
          });
          loadPosts();
        };
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.onclick = async () => {
          await fetch(`/api/posts/${p.id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          loadPosts();
        };
        li.append(editBtn, delBtn);
      }
      list.appendChild(li);
    });
  }

  async function logout() {
    await fetch('/api/auth/logout', { method: 'POST' });
    localStorage.removeItem('token');
    window.location.href = '/';
  }
</script>

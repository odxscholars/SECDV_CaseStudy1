<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Employee Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
<div class="max-w-4xl mx-auto space-y-6">
    <header class="flex items-center justify-between">
        <h2 id="welcome" class="text-2xl font-bold">Employee Dashboard</h2>
        <button onclick="logout()" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Logout</button>
    </header>
    <ul id="loginLog" class="text-sm space-y-1">
        <li id="lastSuccessfulLogin"></li>
        <li id="lastFailedLogin"></li>
    </ul>

    <section class="bg-white p-4 rounded shadow">
        <button onclick="viewProfile()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">View My Profile</button>
    </section>

    <section class="bg-white p-4 rounded shadow">
        <h3 class="text-xl font-semibold mb-4">Create Post</h3>
        <form id="postForm" class="space-y-2">
            <textarea name="content" required class="w-full border px-3 py-2 rounded"></textarea>
            <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">Post</button>
        </form>
    </section>

    <section class="bg-white p-4 rounded shadow">
        <h3 class="text-xl font-semibold mb-4">Posts</h3>
        <ul id="postList" class="space-y-1"></ul>
    </section>

    <section class="bg-white p-4 rounded shadow">
        <h3 class="text-xl font-semibold mb-4">Change Password</h3>
        <form id="passwordForm" class="space-y-2">
            <input name="oldPassword" type="password" placeholder="Old Password" required class="w-full border px-3 py-2 rounded" />
            <input name="newPassword" type="password" placeholder="New Password" required id="passwordInput" class="w-full border px-3 py-2 rounded"/>
            <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">Change</button>
        </form>

        <p class="mt-4 text-sm"> Your new password must contain: </p>
        <ul id="passwordChecklist" class="list-disc list-inside text-sm space-y-1">
            <li id="check-length">❌ At least 8 characters</li>
            <li id="check-uppercase">❌ One uppercase letter</li>
            <li id="check-lowercase">❌ One lowercase letter</li>
            <li id="check-number">❌ One number</li>
            <li id="check-special">❌ One special character</li>
        </ul>
    </section>

    <section class="bg-white p-4 rounded shadow">
        <h3 class="text-xl font-semibold mb-4">Update Recovery</h3>
        <form id="recoveryForm" class="space-y-2">
            <input name="password" type="password" placeholder="Password" required id="recoveryPasswordInput" class="w-full border px-3 py-2 rounded"/>
            <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">Change Recovery Questions</button>
        </form>
    </section>
</div>

<script>
  const token = localStorage.getItem('token');
  let currentUser = null;

  fetch('/api/auth/session').then(res => res.json()).then(u => {
    currentUser = u;
    document.getElementById('welcome').textContent = `Welcome, ${u.user.username}`;
    document.getElementById('lastSuccessfulLogin').textContent = u.user.lastLogin 
      ? `Last successful login: ${new Date(u.user.lastLogin).toLocaleString()}`
      : 'Last successful login: Never';
    document.getElementById('lastFailedLogin').textContent = u.user.lastFailedLogin 
      ? `Last failed login: ${new Date(u.user.lastFailedLogin).toLocaleString()}`
      : 'Last failed login: Never';
    loadPosts();
  }).catch(() => {
    loadPosts();
  });

  async function viewProfile() {
    const res = await fetch('/api/users/me', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await res.json();
    alert(JSON.stringify(data));
  }

  document.getElementById('postForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const content = e.target.content.value.trim();
    if (!content) return;
    await fetch('/api/posts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({ content })
    });
    e.target.reset();
    loadPosts();
  });

  async function loadPosts() {
    const res = await fetch('/api/posts', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const posts = await res.json();
    const list = document.getElementById('postList');
    list.innerHTML = '';
    posts.forEach(p => {
      const li = document.createElement('li');
      li.textContent = `[${new Date(p.createdAt).toLocaleString()}] ${p.author}: ${p.content}`;
      if (currentUser && p.author === currentUser.username) {
        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.onclick = async () => {
          const newContent = prompt('Edit post', p.content);
          if (!newContent) return;
          await fetch(`/api/posts/${p.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ content: newContent })
          });
          loadPosts();
        };
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.onclick = async () => {
          await fetch(`/api/posts/${p.id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          loadPosts();
        };
        li.append(editBtn, delBtn);
      }
      list.appendChild(li);
    });
  }

  const passwordInput = document.getElementById('passwordInput');
  const checkLength = document.getElementById('check-length');
  const checkUppercase = document.getElementById('check-uppercase');
  const checkLowercase = document.getElementById('check-lowercase');
  const checkNumber = document.getElementById('check-number');
  const checkSpecial = document.getElementById('check-special');

  passwordInput.addEventListener('input', () => {
    const password = passwordInput.value;

    updateChecklist(checkLength, password.length >= 8);
    updateChecklist(checkUppercase, /[A-Z]/.test(password));
    updateChecklist(checkLowercase, /[a-z]/.test(password));
    updateChecklist(checkNumber, /[0-9]/.test(password));
    updateChecklist(checkSpecial, /[\W_]/.test(password));
  });

  function updateChecklist(element, valid) {
    if (valid) {
        element.textContent = '✅ ' + element.textContent.slice(2);
        element.classList.add('valid');
        element.classList.remove('invalid');
    } else {
        element.textContent = '❌ ' + element.textContent.slice(2);
        element.classList.add('invalid');
        element.classList.remove('valid');
    }
  }

  function resetChecklist() {
    updateChecklist(checkLength, false);
    updateChecklist(checkUppercase, false);
    updateChecklist(checkLowercase, false);
    updateChecklist(checkNumber, false);
    updateChecklist(checkSpecial, false);
  }

  document.getElementById('passwordForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const oldPassword = form.oldPassword.value;
    const newPassword = form.newPassword.value;

    const minLength = 8;
    const hasUppercase = /[A-Z]/.test(newPassword);
    const hasLowercase = /[a-z]/.test(newPassword);
    const hasNumber    = /[0-9]/.test(newPassword);
    const hasSpecial   = /[\W_]/.test(newPassword);

    const missing = [];

    if (newPassword.length < minLength) missing.push(`at least ${minLength} characters`);
    if (!hasUppercase) missing.push('an uppercase letter');
    if (!hasLowercase) missing.push('a lowercase letter');
    if (!hasNumber)    missing.push('a number');
    if (!hasSpecial)   missing.push('a special character');

    if (missing.length > 0) {
      alert(`New password must include ${missing.join(', ')}.`);
      return;
    }

    const res = await fetch('/api/users/me/password', {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ oldPassword, newPassword })
    });

    const data = await res.json();
    alert(data.message);
    form.reset();
    resetChecklist();
  });

  document.getElementById('recoveryForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const password = document.getElementById('recoveryPasswordInput').value;

    const sessionRes = await fetch('/api/auth/session');
    const sessionData = await sessionRes.json();
    const username = sessionData.user?.username;

    if (!username) {
      alert('Unable to retrieve session. Please log in again.');
      return;
    }

    const res = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });

    const data = await res.json();

    if (res.ok) {
      document.getElementById('recoveryPasswordInput').value = '';
      window.location.href = '/updateRecovery.html';
    } else {
      alert(data.message || 'Password verification failed.');
    }
  });

  async function logout() {
    await fetch('/api/auth/logout', { method: 'POST' });
    localStorage.removeItem('token');
    window.location.href = '/';
  }
</script>
</body>
</html>
